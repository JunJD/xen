# BI-004: 分析失败时返回值不稳定

状态: 已修复  
修复日期: 2026-02-13

## 现象

- 分析接口在失败场景下可能返回 `null`，上层调用要做额外判空分支。
- 调用链复杂时容易出现遗漏处理。

## 根因

- 协议层没有统一“失败时的安全返回值”，不同节点返回语义不一致。

## 修复方案

- 在 offscreen 消息处理层对分析结果统一兜底: `tokens: tokens ?? []`。
- 在 background 构建 token 阶段统一兜底为空数组，避免抛出或传播空值。

## 关键改动文件

- `entrypoints/offscreen/main.ts`
- `entrypoints/background.ts`

## 验收标准

1. 任意失败路径下，分析请求都能稳定返回数组类型。
2. 上层渲染/缓存逻辑可仅按数组处理，不依赖 `null` 分支。
3. 失败时不会导致 UI 崩溃。

## 回归测试用例

1. 输入空字符串、极短字符串、非英文字符串，返回应为数组（可为空）。
2. 模型未就绪时触发分析，返回空数组且不阻塞主流程。
3. 缓存层对空数组处理正常，不写入异常数据结构。
